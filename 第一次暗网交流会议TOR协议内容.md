# 2021/1/18第一次暗网交流会议内容笔记-----Tor相关内容
___

#阅读论文：第二代洋葱头路由匿名通信系统 刘鑫

**一.Tor 协议**

Tor的设计引入了完美的前向机密、拥塞控制、目录服务、完整性校验、可配置的出口策略和端到端完整性校验等机制。

Tor有两种实体，分别是Tor用户和Tor节点。Tor 节点提供中继服务，是Tor网络的主体。Tor 用户在系统中运行本地代理Onion Proxy (OP) 程序，该程序选择中继节点，通过中继节点建立通道，接收应用TCP数据流；并将该数据流通过已建立通道传输。


每个 Tor节点都具有一组身份秘钥(identity key)和一组洋葱头秘钥(onion key)。<font color=#FF0000 >身份秘钥</font>用来签署Tor节点的路由描述符。**路由描述符**是一个集合，包括该节点的洋葱头秘钥、地址、带宽、出口机制等，注册在目录服务中。<font color=#FF0000 >洋葱头秘钥</font>用来建立传输通道以及协商传输的会话秘钥，洋葱头密钥是一个公钥体系，用来在Diffie-Hellman过程中加密g^x，协商获得对称会话密钥。


**二.传输单元**
Tor网络使用固定大小的传输单元（cell），每个单元大小为 512 字节，由单元头和单元负载组
成。单元头包括通道标识符（circID）和通道命令（command）。通道标识符路由指明了传输单元的通道标识，中继 Tor 节点根据该标识符路由传输单元；通道命令指明传输单元中单元负载的作用。基于通道命令，传输单元可以分为**控制单元**和**中继单元**。控制单元用来传输控制命令，包括用于通道的建立的 create和created 命令等。中继单元用于通道中端到端的数据传输。


**三.通道和数据流**
###3.1 通道建立：
<font color=#0000FF >第一步：</font>需要选出入口节点，中间节点，出口节点。选择方法如下：

1.首先客户端的洋葱代理先从目录服务器中得到所有Tor节点的信息。

2.出口节点：先选择出口节点，从出口机制允许的Tor节点中选择出一个作为出口节点。

3.中间节点：其次选择中间节点，从得到的所有Tor节点中选择一个中间节点。

4.入口节点：最后选择入口节点，洋葱代理从**Guard节点列表**中随机选择一个Tor节点作为通道入口节点。每一个Tor用户都在本地维持一个相关稳定的顺序的Guard节点列表。Guard节点列表包括三个Tor节点从具有较长在线时间和较高带宽的 Tor 节点中选择。


<font color=#0000FF >第二步：</font>本地的洋葱代理通过Diffie-Hellman方法和入口节点，中间节点，出口节点分别各自商量出一个会话密钥**k1**,**k2**,**k3**。

###3.2 应用数据传输

1.应用连接建立过程：

(1)应用程序通过SOCK协议和洋葱代理建立连接。

(2)洋葱代理(OP)选择最近建立通道，将应用数据流复用到通道中。

(3)OP发送中继单元子命令relay begin给该通道的出口节点，relay begin子命令单元的负载为目的服务的类型和地址。

(4) 出口节点代表用户和目的服务建立应用级的连接(TCP连接)，同时发送 relay connected子命令单元给 OP，告知应用级连接建立完毕。

2.一旦应用级连接建立后，就可以进行应用数据的传输。应用数据被分割为固定大小（498 字节），通过中继单元relay data子命令进行传输。每一个relay data单元依次使用共享会话密钥进行加密，密钥由内到外的顺序为:出口节点共享密钥、中间结点共享密钥和入口节点共享密钥。当中继节点接收到relay data 单元后，使用共享会话密钥进行解密，剥离一层数据加密，然后将relay data单元传输给下一个中继节点，出口节点解密后得到明文数据，并将明文数据传输给目的服务。

对于目的服务的返回数据，中继节点依次使用会话密钥进行加密，并沿着通道依次回溯传输，当
OP接收到返回数据后，依次使用会话密钥进行解密，得到明文数据且拼装完成后通过SOCK协议传输给应用程序。

#总结如下：

1.首先进行选择三个中继节点，得到会话密钥，建立通道连接。

2.应用程序通过SOCK协议和洋葱代理建立连接。这里数据也是加密的。

3.洋葱代理选择通道，和出口节点进行通信告诉它目的服务的类型和地址，出口节点和目的服务建立连接。应用级别的连接建立。

4.应用程序可以开始发送应用数据，通过SOCK协议给洋葱代理，随后洋葱代理对数据进行三层加密,传输给入口节点，经过入口节点、中间节点、出口节点层层解密。出口节点将明文数据传输给目的服务。**注意：这里从出口节点到目的服务的一段数据是以明文传输的。**

5.数据返回的过程同样的原理。


---


#阅读论文：匿名通信系统与暗网研究综述 罗军舟

Tor暗网的基本组件包括客户端、目录服务器、隐藏服务目录服务器、洋葱路由器和隐藏服务器。

(1)客户端：客户端是运行在用户操作系统上的本地程序，称为洋葱代理。OP将用户数据封装成 Tor信元并层层加密，和应用服务产生的数据加密交互，为各类TCP应用程序提供匿名代理服务。

(2)洋葱路由器:Tor暗网中的数据中继节点。Tor默认匿名链路由３个洋葱路由器OR组成，分别为入口节点(Entry)、中间节点(Middle)和出口节点(Exit)，其中入口节点一般选择可信度较高的守护节点(Guard)。

(3)隐藏服务器:提供Ｗeb，IRC等TCP应用服务。隐藏服务器受到Tor匿名性的保护,必须使用
Tor客户端才能够访问其TCP应用服务。

(4)目录服务器：目录服务器保存了所有洋葱路由器的IP地址、带宽等信息。客户端在首次启动后
向目录服务器请求洋葱路由器信息，以便完成节点选择和链路建立。

(5)隐藏服务目录服务器:隐藏服务目录服务器存储并为客户端提供隐藏服务器的引入节点、公钥等节点信息。

客户端、洋葱路由器、目录服务器、隐藏服务目录服务器和隐藏服务器的功能都集成在Tor软件包中，用户可以通过配置文件对具体功能进行配置。Tor隐藏服务器在启动时会选择３个引入节点
作为其前置代理，并将引入节点及其公钥信息上传至隐藏服务目录服务器。客户端访问隐藏服务时，首先建立３跳链路访问隐藏服务目录服务器，获取引入节点和公钥信息．客户端选择一个汇聚节点作为客户端和隐藏服务器通信链路的汇聚点，并将汇聚节点的信息通过引入节点告知隐藏服务器。

客户端和隐藏服务器各自建立到达汇聚节点的链路，完成６跳链路的搭建后即可开始通信。Tor用户通过６跳链路访问隐藏服务器，在此过程中任意节点无法同时获知Tor客户端IP地址、隐藏服务 器IP地址以及数据内容，保障了Tor客户端与隐藏服务器的匿名性。

---

#阅读网页：Tor项目中涉及的握手协议。  ip:https://blog.csdn.net/WInScar/article/details/8913910

握手协议分为三层，TCP协议握手、TLS协议握手、Tor协议握手。

TCP握手、TLS握手是在客户端的洋葱代理上和入口节点(网桥)进行，建立联系。Tor握手是在客户端的洋葱代理上和入口节点、中间节点、出口节点上进行，协商三个会话密钥，建立联系。

1.中继选择：客户端洋葱代理选择三跳节点，先和入口节点开始TCP握手，TLS握手，建立起TLS联系。

2.通道建立：用TLS加密，客户端洋葱代理和三个中继节点进行握手，协商密钥。Tor握手时g^x被用中继节点的公钥加密,整个数据包被TLS加密。

3.应用连接建立：应用程序通过SOCK协议和洋葱代理建立连接；洋葱代理(OP)选择最近建立通道，将应用数据流复用到通道中；OP发送中继单元子命令relay-begin给该通道的出口节点，relay-begin子命令单元的负载为目的服务的类型和地址；出口节点代表用户和目的服务建立应用级的连接(TCP连接)，进行TCP握手，(这里是出口和目标服务地址之间的TCP握手，我们抓不到)同时发送 relay connected子命令单元给 OP，告知应用级连接建立完毕。

**总结：**OR握手是建立在TLS握手基础上的。Tor系统中双方在通信TLS握手完成之后，立即进行相对应的OR握手。而在这个过程中，使用到的TLS握手方式也是不一定相同的。Tor系统会根据版本的不同，而实行不同的握手方式。

---
#阅读网页 匿名通信网络Tor、I2P关键技术研究 IP:https://image.hanspub.org/Html/10-1541453_31299.htm

一.Tor系统架构和协议层次

Tor是用C语言编写的匿名P2P网络的多应用程序，下图表示了Tor网络体系结构、协议层次模型。

![Tor系统架构](F:\读书笔记\暗网\2021-1-18暗网组会-Tor协议内容\架构.png)

Tor层是Tor网络的关键部分，由Tor路由节点建立通信电路，可以将其看作为代理服务器，是它将客户端数据传输到网络中，并从网络中获取服务器端数据。应用层主要有应用代理和退出的连接功能；Tor协议层主要有洋葱路由、电路创建协议；传输层有TCP、SSL/TLS协议，TLS的主要功能是用于电路的加密。

二.Tor工作流程

![Tor工作流程](F:\读书笔记\暗网\2021-1-18暗网组会-Tor协议内容\流程.png)

说明Tor网络的工作流程，用户可以通过搜索Tor目录服务器或网桥登录Tor网络。

三.Tor关键技术

![Tor关键技术](F:\读书笔记\暗网\2021-1-18暗网组会-Tor协议内容\关键技术.png)

四.路由方法

![Tor路由方法](F:\读书笔记\暗网\2021-1-18暗网组会-Tor协议内容\路由方法.png)

洋葱路由的目的是让对手更难以进行流量分析，同时首先要保护两个与第三方相互认识的参与者的不可链接性，其次是保护身份。由上图可知，只有电路中的第一个OR知道客户端的IP地址，并且只有电路的最后一个OR知道消息的接收者，所有中间OR只知道它的前身及其后继者，甚至不知道哪些其他OR正在参与电路，通过三个节点间的双向电路构成网络。由于缺少覆盖流量，攻击者可能会使用流量分析和定时攻击来监控流量模式，跟踪消息流并识别通信方。

五.信息机制和交换方法

如下图所示，Tor协议中的协议数据交换使用的是固定长度的Cell，流量在网络中以固定大小的单元进行传输，每个单元是包含头和有效载荷的12字节数据。头包括一个线路标识符(这个单元使用哪条线路)和一个指令(指明将要对这个单元的数据做什么)。中继单元在有效载荷数据之前有额外的头(中继头)，包含了一个stream ID、一个端到端的校验和、中继负载的长度和一个中继命令。

![Tor网络的cell结构](F:\读书笔记\暗网\2021-1-18暗网组会-Tor协议内容\数据交换.png)